<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Wagon Transport Order Confirmation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            min-height: 100vh;
            background-color: #f4f7fa;
            font-family: 'Montserrat', sans-serif;
        }

        .header-section {
            background-color: #00002d;
            color: white;
            padding: 40px;
            border-radius: 12px 12px 0 0;
        }
        
        .header-section h1 {
            font-weight: 700;
            font-size: 2.5rem;
        }

        .main-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 40px auto;
            max-width: 1000px;
        }

        .login-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 100px auto;
            max-width: 450px;
            padding: 40px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #00002d;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #6b7280;
        }

        .form-control, .form-select {
            background-color: #f0f3f8;
            border: 1px solid #d1d5db;
            color: #1f2937;
            font-weight: 500;
            font-size: 1rem;
            height: 44px;
        }

        .form-label {
            font-weight: 600;
            color: #00002d;
            margin-bottom: 5px;
        }
        
        .route-section {
            border: 2px solid #3b82f6;
            border-radius: 12px;
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f8fafc;
        }

        .route-section h4 {
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3b82f6;
        }

        .order-card {
            border: 1px solid #e5e7eb;
            border-left: 5px solid #10b981;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #ffffff;
        }

        .order-card h5 {
            font-weight: 700;
            color: #10b981;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f3f8;
            padding-bottom: 5px;
        }

        .time-slot-section {
            background-color: #fff7ed;
            border: 2px solid #fb923c;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .time-slot-section h6 {
            color: #ea580c;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .btn-custom {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 10px 30px;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-custom:hover {
            background-color: #1e3a8a;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container">
        <div class="login-card">
            <div class="login-header">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo" style="height: 60px; margin-bottom: 20px;">
                <h2>Anmeldung erforderlich</h2>
                <p>Bitte melden Sie sich an, um auf die Transportauftr√§ge zuzugreifen.</p>
            </div>
            
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Benutzername</label>
                    <input type="text" class="form-control" id="username" name="username" required autocomplete="username">
                </div>
                
                <div class="mb-4">
                    <label for="password" class="form-label">Passwort</label>
                    <input type="password" class="form-control" id="password" name="password" required autocomplete="current-password">
                </div>
                
                <div id="login-alert" class="mb-3"></div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-custom" id="login-btn">
                        <span id="login-btn-text">Anmelden</span>
                        <span id="login-spinner" class="spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="main-app" class="container hidden">
        <div class="main-card">
            <div class="header-section text-center">
                <h1>Wagon Transport Order Editor <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo" style="height: 1.2em; vertical-align: middle;"></h1>
                <p class="lead" style="color: #dbeafe;">Bitte √ºberpr√ºfen und best√§tigen Sie die Liefer-/Abhol-Slots.</p>
            </div>

            <div class="p-4">
                <form id="order-form">
                    <div id="orders-container">
                        <div class="alert alert-info" role="alert">Lade Bestelldaten...</div>
                    </div>

                    <div id="alert-container" class="mt-4"></div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-custom mt-3">Auftr√§ge best√§tigen & an Logistik senden</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const AUTH_FLOW_URL = 'https://e157ee54d75be7b59e64b3c2c12166.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3f3444f8c3514fe8873204c368389636/triggers/manu[...]
        const ORDER_SUBMIT_URL = 'https://e157ee54d75be7b59e64b3c2c12166.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/57811f085180473188001322dee3482f/triggers/m[...]
        
        // Session token storage
        let sessionToken = null;

        // Configuration
        const CONFIG = {
            profiles: ['G1', 'G2'],
            wagonTypes: ['Offen', 'Geschlossen', 'Offen + Geschlossen'],
            reasons: [
                { value: 'None', text: '‚Äî Keine Unterlieferung ‚Äî' },
                { value: '01', text: '01 Fehlende Fahrzeuge (z.B. geringe Produktion,...)' },
                { value: '02', text: '02 BMW AQ-Sperre' },
                { value: '03', text: '03 St√∂rungen in der Montage' },
                { value: '04', text: '04 Technische St√∂rungen BMW' },
                { value: '05', text: '05 Falsche Waggongattung angeliefert' },
                { value: '06', text: '06 Fehlende Waggons - Schadwaggon' },
                { value: '07', text: '07 Ausrangierung Schadwaggons' }
            ]
        };

        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('login-alert');
            alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                            ${message}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
        }
        
        function generateTimeSlots(intervalMinutes) {
            const slots = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += intervalMinutes) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    if (intervalMinutes === 15) {
                        slots.push({ value: time, text: time });
                    } else if (intervalMinutes === 120 && m === 0) {
                        const nextHour = String((h + 2) % 24).padStart(2, '0');
                        const slotText = `${time} - ${nextHour}:00`;
                        slots.push({ value: slotText, text: slotText });
                    }
                }
            }
            return slots;
        }

        const arrivalSlots = generateTimeSlots(120);
        const departureSlots = generateTimeSlots(15);
        
        function getOrdersFromUrl() {
            try {
                const params = new URLSearchParams(window.location.search);
                const encodedData = params.get('data');
                if (!encodedData) {
                    return [];
                }
                const jsonString = decodeURIComponent(encodedData);
                const parsedData = JSON.parse(jsonString);
                return Array.isArray(parsedData) ? parsedData : [parsedData];
            } catch (e) {
                console.error("Fehler beim Parsen der Bestelldaten:", e);
                return [];
            }
        }

        function getRouteKey(order) {
            const departure = order.departure || order.Departure || 'UNKNOWN';
            const destination = order.destination || order.Destination || 'UNKNOWN';
            return `${departure}|||${destination}`;
        }

        function createTimeSlotSection(routeKey, departure, destination) {
            const arrivalOptions = arrivalSlots.map(s => 
                `<option value="${s.value}">${s.text}</option>`
            ).join('');

            const departureOptions = departureSlots.map(s => 
                `<option value="${s.value}">${s.text}</option>`
            ).join('');

            return `
                <div class="time-slot-section">
                    <h6>üïê Zeit-Slots f√ºr Route: ${departure} ‚Üí ${destination}</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="arrival-${routeKey}" class="form-label">Arrival Time Slot (2h)</label>
                            <select class="form-select" id="arrival-${routeKey}" name="arrival-${routeKey}" required>
                                ${arrivalOptions}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="departure-${routeKey}" class="form-label">Departure Time (15min)</label>
                            <select class="form-select" id="departure-${routeKey}" name="departure-${routeKey}" required>
                                ${departureOptions}
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createOrderCard(order) {
            const id = order.orderId || 'UNKNOWN';
            
            const profileOptions = CONFIG.profiles.map(p => 
                `<option value="${p}" ${p === order.wagonProfile ? 'selected' : ''}>${p}</option>`
            ).join('');
            
            const typeOptions = CONFIG.wagonTypes.map(t => 
                `<option value="${t}" ${t === order.wagonType ? 'selected' : ''}>${t}</option>`
            ).join('');

            const reasonOptions = CONFIG.reasons.map(r => 
                `<option value="${r.value}">${r.text}</option>`
            ).join('');

            return `
                <div class="order-card" data-order-id="${id}">
                    <h5>Order ID: ${id} | Supplier: ${order.supplier || 'N/A'}</h5>
                    <p class="mb-3 text-muted small">KW: ${order.cw || 'N/A'}</p>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="wagons-${id}" class="form-label">Wagons (Qty.)</label>
                            <input type="number" class="form-control" id="wagons-${id}" name="wagons-${id}" value="${order.wagons || 1}" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="date-${id}" class="form-label">Transport Date</label>
                            <input type="date" class="form-control" id="date-${id}" name="date-${id}" value="${order.transportDate || ''}" required>
                        </div>
                        <div class="col-md-3">
                            <label for="profile-${id}" class="form-label">Wagon Profile</label>
                            <select class="form-select" id="profile-${id}" name="profile-${id}" required>
                                ${profileOptions}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="type-${id}" class="form-label">Wagon Type</label>
                            <select class="form-select" id="type-${id}" name="type-${id}" required>
                                ${typeOptions}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="reason-${id}" class="form-label">Reason for Underdelivery</label>
                            <select class="form-select" id="reason-${id}" name="reason-${id}" required>
                                ${reasonOptions}
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="comment-${id}" class="form-label">Comment (Free Text)</label>
                            <textarea class="form-control" id="comment-${id}" name="comment-${id}" rows="2" placeholder="Freitextkommentar eingeben..."></textarea>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadForm() {
            const ordersData = getOrdersFromUrl();
            const container = document.getElementById('orders-container');
            container.innerHTML = '';
            
            if (ordersData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <strong>Fehler:</strong> Es wurden keine Bestelldaten √ºbergeben oder die Daten konnten nicht geladen werden.
                        <br><br>
                        Bitte wenden Sie sich an das Logistik-Team oder √ºberpr√ºfen Sie den Link.
                    </div>`;
                const submitBtn = document.querySelector('#order-form button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }

            // Group orders by route (Departure -> Destination)
            const routeGroups = {};
            ordersData.forEach(order => {
                const routeKey = getRouteKey(order);
                if (!routeGroups[routeKey]) {
                    routeGroups[routeKey] = {
                        departure: order.departure || order.Departure || 'UNKNOWN',
                        destination: order.destination || order.Destination || 'UNKNOWN',
                        orders: []
                    };
                }
                routeGroups[routeKey].orders.push(order);
            });

            // Create a section for each route
            Object.keys(routeGroups).forEach(routeKey => {
                const group = routeGroups[routeKey];
                
                const routeSection = document.createElement('div');
                routeSection.className = 'route-section';
                
                routeSection.innerHTML = `
                    <h4>üìç Route: ${group.departure} ‚Üí ${group.destination}</h4>
                    ${createTimeSlotSection(routeKey, group.departure, group.destination)}
                    <div class="orders-list mt-3">
                        ${group.orders.map(order => createOrderCard(order)).join('')}
                    </div>
                `;
                
                container.appendChild(routeSection);
            });
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="font-size: 1rem;">
                                            ${message}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - Login screen should be visible');
            
            // Handle Login with Power Automate Authentication
            document.getElementById('login-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                // Show loading state
                const loginBtn = document.getElementById('login-btn');
                const loginBtnText = document.getElementById('login-btn-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                loginBtn.disabled = true;
                loginBtnText.textContent = '√úberpr√ºfung...';
                loginSpinner.classList.remove('hidden');
                
                try {
                    // Call Power Automate authentication flow
                    const response = await fetch(AUTH_FLOW_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: username,
                            password: password,
                            timestamp: new Date().toISOString()
                        })
                    });

                    const result = await response.json();
                    
                    if (response.ok && result.authenticated === true) {
                        console.log('Login successful');
                        // Store session token if provided
                        sessionToken = result.token || null;
                        
                        // Successful login
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        loadForm();
                    } else {
                        console.log('Login failed');
                        showLoginAlert('Ung√ºltiger Benutzername oder Passwort. Bitte versuchen Sie es erneut.', 'danger');
                        
                        // Reset button state
                        loginBtn.disabled = false;
                        loginBtnText.textContent = 'Anmelden';
                        loginSpinner.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    showLoginAlert('Verbindungsfehler. Bitte versuchen Sie es sp√§ter erneut.', 'danger');
                    
                    // Reset button state
                    loginBtn.disabled = false;
                    loginBtnText.textContent = 'Anmelden';
                    loginSpinner.classList.add('hidden');
                }
            });

            // Handle Order Form Submission
            document.getElementById('order-form').addEventListener('submit', async function (event) {
                event.preventDefault();
                
                const ordersData = [];
                const orderCards = document.querySelectorAll('.order-card');
                
                // Get all time slots by route
                const timeSlotsByRoute = {};
                document.querySelectorAll('.time-slot-section').forEach(section => {
                    const arrivalSelect = section.querySelector('select[id^="arrival-"]');
                    const departureSelect = section.querySelector('select[id^="departure-"]');
                    
                    if (arrivalSelect && departureSelect) {
                        const routeKey = arrivalSelect.id.replace('arrival-', '');
                        timeSlotsByRoute[routeKey] = {
                            arrival: arrivalSelect.value,
                            departure: departureSelect.value
                        };
                    }
                });
                
                orderCards.forEach(card => {
                    const id = card.getAttribute('data-order-id');
                    
                    // Find the route key for this order
                    const routeSection = card.closest('.route-section');
                    const routeHeading = routeSection ? routeSection.querySelector('h4').textContent : '';
                    
                    // Extract departure and destination from heading
                    const routeMatch = routeHeading.match(/üìç Route: (.+) ‚Üí (.+)/);
                    let routeKey = '';
                    if (routeMatch) {
                        const departure = routeMatch[1].trim();
                        const destination = routeMatch[2].trim();
                        routeKey = `${departure}|||${destination}`;
                    }
                    
                    const timeSlots = timeSlotsByRoute[routeKey] || { arrival: '', departure: '' };
                    
                    const orderData = {
                        orderId: id,
                        wagons: parseInt(document.getElementById(`wagons-${id}`).value, 10),
                        transportDate: document.getElementById(`date-${id}`).value,
                        wagonProfile: document.getElementById(`profile-${id}`).value,
                        wagonType: document.getElementById(`type-${id}`).value,
                        timeSlotArrival: timeSlots.arrival,
                        departureTime: timeSlots.departure,
                        reasonUnderdelivery: document.getElementById(`reason-${id}`).value,
                        comment: document.getElementById(`comment-${id}`).value
                    };
                    
                    ordersData.push(orderData);
                });
                
                const finalPayload = {
                    submissionTimestamp: new Date().toISOString(),
                    sessionToken: sessionToken,
                    orders: ordersData
                };

                try {
                    const response = await fetch(ORDER_SUBMIT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(finalPayload)
                    });

                    if (response.ok) {
                        showAlert('Success! Alle Transportauftr√§ge wurden best√§tigt und an die Logistik gesendet.', 'success');
                        document.getElementById('order-form').querySelector('button[type="submit"]').disabled = true;
                    } else {
                        const errorText = await response.text();
                        showAlert(`√úbermittlung fehlgeschlagen. Server-Status: ${response.status}.`, 'danger');
                    }
                } catch (error) {
                    showAlert('Ein Fehler ist aufgetreten. Bitte pr√ºfen Sie Ihre Verbindung oder wenden Sie sich an den Support.', 'danger');
                    console.error("Fetch Error:", error);
                }
            });
        });
    </script>
</body>
</html>
